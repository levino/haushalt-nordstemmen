---
import Layout from '../layouts/Layout.astro';
---

<Layout title="LSN-Online Datenbank - Technische Dokumentation">
  <section class="section">
    <div class="container">
      <h1>LSN-Online Datenbank</h1>
      <p class="lead">
        Technische Dokumentation zur Nutzung der LSN-Online Regionaldatenbank des
        Landesamts für Statistik Niedersachsen.
      </p>

      <div class="alert alert-info">
        <strong>Hinweis:</strong> Die LSN-Online bietet keine dokumentierte öffentliche API.
        Diese Dokumentation basiert auf Reverse-Engineering der Web-Oberfläche.
      </div>

      <h2>Übersicht</h2>
      <table>
        <tr>
          <td><strong>URL</strong></td>
          <td><a href="https://www1.nls.niedersachsen.de/statistik/" target="_blank">www1.nls.niedersachsen.de/statistik</a></td>
        </tr>
        <tr>
          <td><strong>Technologie</strong></td>
          <td>Classic ASP (Active Server Pages)</td>
        </tr>
        <tr>
          <td><strong>Datenpunkte</strong></td>
          <td>~90 Millionen</td>
        </tr>
        <tr>
          <td><strong>Tabellen</strong></td>
          <td>Über 1.000</td>
        </tr>
        <tr>
          <td><strong>Granularität</strong></td>
          <td>Bis Gemeindeebene</td>
        </tr>
        <tr>
          <td><strong>Zeitreihen</strong></td>
          <td>Teilweise ab 1983</td>
        </tr>
        <tr>
          <td><strong>Kosten</strong></td>
          <td>Kostenfrei</td>
        </tr>
      </table>

      <h2>Architektur</h2>

      <div class="card">
        <h3>Frame-basierte Struktur</h3>
        <p>Die Website verwendet eine verschachtelte Frame-Architektur:</p>
        <pre><code>default.asp                 # Einstiegsseite mit Login-Form
├── html/
│   ├── oben_link.htm       # Kopfzeile
│   ├── haupt_wrapper.asp   # Wrapper-Frame
│   │   └── haupt_neu.asp   # Hauptnavigation mit dTree
│   ├── param_haupt.asp     # Parameter-Auswahl-Formulare
│   └── mustertabelle.asp   # Tabellen-Generator
└── pool/[TABLE_ID]/        # Generierte Ergebnis-Dateien
    └── [TABLE_ID]_[HASH].asp/.zip</code></pre>
      </div>

      <div class="card">
        <h3>Session-Management</h3>
        <p>Die Datenbank verwendet Session-Cookies für die Zustandsverwaltung:</p>
        <ol>
          <li>Initiale Anfrage an <code>default.asp</code></li>
          <li>POST mit <code>LOGIN1=WEITER</code> startet Session</li>
          <li>Cookie <code>AL_SESS-S</code> wird gesetzt</li>
          <li>Keep-Alive via <code>ticker.asp</code> (alle 60 Sekunden)</li>
        </ol>
      </div>

      <h2>API-Endpunkte</h2>

      <div class="card">
        <h3>1. Session starten</h3>
        <pre><code>POST https://www1.nls.niedersachsen.de/statistik/default.asp
Content-Type: application/x-www-form-urlencoded

LOGIN1=WEITER</code></pre>
        <p>Setzt Session-Cookie und leitet zur Hauptseite weiter.</p>
      </div>

      <div class="card">
        <h3>2. Menü-Navigation</h3>
        <pre><code>GET https://www1.nls.niedersachsen.de/statistik/html/haupt_neu.asp?MENU=[ID]</code></pre>
        <p>Menü-IDs:</p>
        <ul>
          <li><code>17</code> - EVAS Systematik (Standard)</li>
          <li><code>7</code> - Statistische Erhebung</li>
          <li><code>11</code> - Leben & Arbeiten</li>
          <li><code>12</code> - Staat & Gesellschaft</li>
          <li><code>13</code> - Wirtschaft & Preise</li>
          <li><code>21</code> - Umwelt & Mobilität</li>
          <li><code>19</code> - Regionalmonitoring</li>
        </ul>
      </div>

      <div class="card">
        <h3>3. Parameter-Formular abrufen</h3>
        <pre><code>GET https://www1.nls.niedersachsen.de/statistik/html/param_haupt.asp
?DT=[TABLE_ID]
&IFR=1
&LN=[EBENE]
&RANGE0=[VON]
&RANGE1=[BIS]</code></pre>
        <p>Parameter:</p>
        <ul>
          <li><code>DT</code> - Tabellen-ID (z.B. K9200001, Z9200001)</li>
          <li><code>IFR</code> - IFrame-Modus (immer 1)</li>
          <li><code>LN</code> - Ebene (1=Land, 2=Region, 3=Kreis, 4=Samtgemeinde, 5=Mitgliedsgemeinde)</li>
          <li><code>RANGE0/RANGE1</code> - Gebietsfilter (z.B. 254026 für Nordstemmen)</li>
        </ul>
      </div>

      <div class="card">
        <h3>4. Daten abrufen</h3>
        <pre><code>POST https://www1.nls.niedersachsen.de/statistik/html/mustertabelle.asp
Content-Type: application/x-www-form-urlencoded

DT=[TABLE_ID]
&ZUFALL=[SESSION_TOKEN]
&UG=[REGION_ID]
&LN=[EBENE]
&LN2=[SUB_EBENE]
&ZEIT=[ZEITRAUM]  # nur für K-Tabellen</code></pre>
        <p>Gibt HTML mit Meta-Refresh zur Ergebnisseite zurück.</p>
      </div>

      <h2>Tabellen-ID Schema</h2>

      <div class="card">
        <h3>Präfix-Bedeutung</h3>
        <table>
          <thead>
            <tr>
              <th>Präfix</th>
              <th>Bedeutung</th>
              <th>Beispiel</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>K</code></td>
              <td>Einzeljahr-Tabelle</td>
              <td>K9200001</td>
            </tr>
            <tr>
              <td><code>Z</code></td>
              <td>Zeitreihen-Tabelle</td>
              <td>Z9200001</td>
            </tr>
            <tr>
              <td><code>M</code></td>
              <td>Mehrere Merkmale</td>
              <td>M9200001</td>
            </tr>
          </tbody>
        </table>

        <h3>Themenbereich-Codes</h3>
        <table>
          <thead>
            <tr>
              <th>Code</th>
              <th>Thema</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>92xxxxx</code></td>
              <td>Realsteuervergleich</td>
            </tr>
            <tr>
              <td><code>94xxxxx</code></td>
              <td>Kommunale Einzahlungen/Auszahlungen</td>
            </tr>
            <tr>
              <td><code>96xxxxx</code></td>
              <td>Schulden der Kommunen</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2>Relevante Tabellen für Kommunalfinanzen</h2>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Tabellen-ID</th>
              <th>Beschreibung</th>
              <th>Ebene</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>K9200001</code></td>
              <td>Steuereinnahmen (Einzeljahr)</td>
              <td>Gemeinde</td>
            </tr>
            <tr>
              <td><code>Z9200001</code></td>
              <td>Steuereinnahmen (Zeitreihe ab 1983)</td>
              <td>Gemeinde</td>
            </tr>
            <tr>
              <td><code>K9200002</code></td>
              <td>Steuerkraft, Hebesätze</td>
              <td>Gemeinde</td>
            </tr>
            <tr>
              <td><code>Z9200002</code></td>
              <td>Steuerkraft (Zeitreihe)</td>
              <td>Gemeinde</td>
            </tr>
            <tr>
              <td><code>K9400012</code></td>
              <td>Einzahlungen nach Arten</td>
              <td>Verwaltungseinheit</td>
            </tr>
            <tr>
              <td><code>K9400013</code></td>
              <td>Auszahlungen nach Arten</td>
              <td>Verwaltungseinheit</td>
            </tr>
            <tr>
              <td><code>K9600050</code></td>
              <td>Schulden und Verbindlichkeiten</td>
              <td>Verwaltungseinheit</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2>Regions-ID für Nordstemmen</h2>

      <div class="card">
        <table>
          <tr>
            <td><strong>LSN-ID</strong></td>
            <td><code>254026000</code></td>
          </tr>
          <tr>
            <td><strong>Kurzform</strong></td>
            <td><code>254026</code></td>
          </tr>
          <tr>
            <td><strong>Amtlicher Gemeindeschlüssel (AGS)</strong></td>
            <td><code>03254035</code></td>
          </tr>
        </table>
        <p class="note">
          Hinweis: Die LSN verwendet ein eigenes ID-Schema, das sich vom amtlichen
          Gemeindeschlüssel unterscheidet.
        </p>
      </div>

      <h2>Beispiel: Daten für Nordstemmen abrufen</h2>

      <div class="card">
        <h3>cURL-Beispiel</h3>
        <pre><code># 1. Session starten
curl -c cookies.txt -b cookies.txt -X POST \
  "https://www1.nls.niedersachsen.de/statistik/default.asp" \
  -d "LOGIN1=WEITER"

# 2. Zeitreihen-Daten abrufen
curl -b cookies.txt -X POST \
  "https://www1.nls.niedersachsen.de/statistik/html/mustertabelle.asp" \
  -d "DT=Z9200001" \
  -d "UG=254026000" \
  -d "LN=5" \
  -d "LN2=1"

# 3. Ergebnis folgt dem Meta-Refresh zur generierten Seite</code></pre>
      </div>

      <div class="card">
        <h3>Python-Script</h3>
        <pre><code>import requests
from bs4 import BeautifulSoup
import re
import time

class LSNClient:
    BASE_URL = "https://www1.nls.niedersachsen.de/statistik"

    def __init__(self):
        self.session = requests.Session()

    def start_session(self):
        """Startet eine LSN-Session."""
        response = self.session.post(
            f"{'{'}self.BASE_URL{'}'}/default.asp",
            data={'{'}LOGIN1': 'WEITER'{'}'}
        )
        return response.ok

    def fetch_table(self, table_id: str, region_id: str = "254026000"):
        """Ruft eine Tabelle für eine Region ab."""
        response = self.session.post(
            f"{'{'}self.BASE_URL{'}'}/html/mustertabelle.asp",
            data={'{'}
                'DT': table_id,
                'UG': region_id,
                'LN': '5',  # Mitgliedsgemeinde
                'LN2': '1'
            {'}'}
        )

        # Folge dem Meta-Refresh
        soup = BeautifulSoup(response.text, 'html.parser')
        meta = soup.find('meta', attrs={'{'}http-equiv': 'refresh'{'}'})
        if meta:
            match = re.search(r"url='([^']+)'", meta['content'])
            if match:
                result_url = f"{'{'}self.BASE_URL{'}'}{'{'}match.group(1){'}'}"
                time.sleep(2)  # Warten auf Generierung
                return self.session.get(result_url)

        return response

# Verwendung
client = LSNClient()
client.start_session()
response = client.fetch_table("Z9200001")  # Zeitreihe Steuereinnahmen
print(response.text)</code></pre>
      </div>

      <h2>Ausgabeformate</h2>

      <div class="card">
        <p>Die generierten Ergebnisse sind verfügbar als:</p>
        <ul>
          <li><strong>HTML-Tabelle</strong> - Direkt im Browser anzeigbar</li>
          <li><strong>ZIP-Archiv</strong> - Enthält Excel-Datei (.xls)</li>
        </ul>
        <p>
          Der Download-Link ist in der Form:
          <code>/Statistik/pool/[TABLE_ID]/[TABLE_ID]_[HASH].zip</code>
        </p>
      </div>

      <h2>Einschränkungen</h2>

      <div class="card">
        <ul>
          <li><strong>Session-Timeout</strong> - Sessions laufen nach Inaktivität ab</li>
          <li><strong>Rate Limiting</strong> - Zu viele Anfragen können blockiert werden</li>
          <li><strong>Geheimhaltung</strong> - Manche Daten sind aus Datenschutzgründen gesperrt</li>
          <li><strong>Keine REST-API</strong> - Nur formularbasierter Zugriff</li>
          <li><strong>Instabile IDs</strong> - Generierte URLs haben zeitlich begrenzte Gültigkeit</li>
        </ul>
      </div>

      <h2>Automatisierung mit Playwright</h2>

      <div class="card">
        <p>
          Für zuverlässige automatisierte Datenextraktion empfehlen wir
          Browser-Automatisierung mit Playwright:
        </p>
        <pre><code># Installation
pip install playwright
playwright install chromium

# Script
python scripts/fetch_lsn_data.py</code></pre>
        <p>
          Das Script im Repository verwendet Playwright, um die komplexe
          Frame-Navigation und JavaScript-Interaktion zu handhaben.
        </p>
      </div>

      <h2>Kontakt LSN</h2>

      <div class="card">
        <p>Für individuelle Datenabfragen oder Hilfe:</p>
        <table>
          <tr>
            <td><strong>Institution</strong></td>
            <td>Landesamt für Statistik Niedersachsen</td>
          </tr>
          <tr>
            <td><strong>Telefon</strong></td>
            <td>0511 9898-1132/1134</td>
          </tr>
          <tr>
            <td><strong>E-Mail</strong></td>
            <td>auskunft@statistik.niedersachsen.de</td>
          </tr>
        </table>
      </div>
    </div>
  </section>
</Layout>

<style>
  .lead {
    font-size: 1.25rem;
    color: var(--color-text-light);
    margin-bottom: 2rem;
  }

  .alert {
    padding: 1rem 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
  }

  .alert-info {
    background: #ebf8ff;
    border: 1px solid #90cdf4;
    color: #2c5282;
  }

  pre {
    background: #1a202c;
    color: #e2e8f0;
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
    margin: 1rem 0;
  }

  code {
    font-family: 'SF Mono', Monaco, Consolas, monospace;
    font-size: 0.875rem;
  }

  :not(pre) > code {
    background: var(--color-bg-alt);
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    color: var(--color-text);
  }

  .card {
    margin-bottom: 1.5rem;
  }

  .card h3 {
    margin-bottom: 1rem;
  }

  .card ul, .card ol {
    margin: 1rem 0;
    padding-left: 1.5rem;
  }

  .card li {
    margin-bottom: 0.5rem;
  }

  .note {
    font-size: 0.875rem;
    color: var(--color-text-light);
    font-style: italic;
    margin-top: 0.5rem;
  }

  table code {
    font-size: 0.8rem;
  }
</style>
